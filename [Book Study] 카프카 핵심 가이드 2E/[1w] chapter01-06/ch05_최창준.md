# 5. í”„ë¡œê·¸ë¨ ë‚´ì—ì„œ ì½”ë“œë¡œ ì¹´í”„ì¹´ ê´€ë¦¬í•˜ê¸°

## 5.1 AdminClient ê°œìš”

### 5.1.1 ë¹„ë™ê¸°ì ì´ê³  ìµœì¢…ì  ì¼ê´€ì„±ì„ ê°€ì§€ëŠ” API

AdminClientëŠ” ë¹„ë™ê¸° ê²°ê³¼ì¸ Future ê°ì²´ë¥¼ `Result ê°ì²´`ë¡œ ê°ì‹¸ì„œ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ê±°ë‚˜ ì‘ì—… ê²°ê³¼ì— ëŒ€í•´ ì¼ë°˜ì ìœ¼ë¡œ ë’¤ì´ì–´ ì“°ì´ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” í—¬í¼ ë©”ì„œë“œë¥¼ ê°€ì§€ê³  ìˆìŒ

**ìµœì¢…ì  ì¼ê´€ì„±(eventual consistency)**

AdminClient APIê°€ ë¦¬í„´í•˜ëŠ” Future ê°ì²´ì˜ ì™„ë£Œ ì—¬ë¶€ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ìƒíƒœê°€ ì™„ì „íˆ ì—…ë°ì´íŠ¸ëœ ìƒíƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤. ì¦‰ ì—¬ëŸ¬ ë¸Œë¡œì»¤ ì¤‘ì—ì„œ ë¦¬ë”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ 1ê°œë§Œ ì¸ì§€í•˜ë©´ Future ê°ì²´ì˜ ê²°ê³¼ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ í† í”½ì„ ìƒì„±í•˜ëŠ” ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” ì¸ì§€í–ˆëŠ”ë° ë‹¤ë¥¸ ë¸Œë¡œì»¤ë“¤ë¡œ ë©”íƒ€ë°ì´í„°ì˜ ì „íŒŒê°€ ì¼ì–´ë‚˜ëŠ” ë™ì•ˆ í† í”½ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ëŠ” listTopics ìš”ì²­ì„ ë³´ë‚´ë©´ ë‹¤ë¥¸ ë¸Œë¡œì»¤ë“¤ì€ ê·¸ ì •ë³´ë¥¼ ëª¨ë¥¼ ìˆ˜ ìˆë‹¤. ì •í™•íˆ ê·¸ íƒ€ì´ë°ì´ ì–¸ì œê°€ ë  ê²ƒì¸ì§€ì— ëŒ€í•´ì„œëŠ” ë³´ì¥ì´ ë¶ˆê°€í•˜ë‹¤.

### 5.1.2 ì˜µì…˜

AdminClientì˜ ê° ë©”ì„œë“œê°€ íŠ¹ì •í•œ `Options ê°ì²´`ë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤.

ex) listTopcis ë©”ì„œë“œëŠ” ListTopicsOptions ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ìŒ

- **timeoutMS**: ëª¨ë“  AdminClient ë©”ì„œë“œê°€ ê°–ê³ ìˆëŠ” ë§¤ê°œë³€ìˆ˜. í´ë¼ì´ì–¸íŠ¸ê°€ TimeoutExceptionì„ ë°œìƒì‹œí‚¤ê¸°ì „ì— í´ëŸ¬ìŠ¤í„°ë¡œë¶€í„° ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ì„ ì¡°ì •í•¨

### 5.1.3 ìˆ˜í‰ êµ¬ì¡°

ëª¨ë“  ì–´ë“œë¯¼ ê¸°ëŠ¥ì´ KafkaAdminClientì— êµ¬í˜„ë˜ì–´ ìˆìŒ. ë„ˆë¬´ í¬ì§€ë§Œ í•˜ë‚˜ì˜ ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´í•˜ë©´ ë˜ë¯€ë¡œ IDE ìë™ì™„ì„± ë“± í¸ì˜ì„±ì´ ìˆìŒ

### 5.1.4 ì¶”ê°€ ì°¸ê³  ì‚¬í•­

- í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ëª¨ë“  ì‘ì—…(create, delete, alter)ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì˜í•´ ìˆ˜í–‰
- í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ì½ê¸°ë§Œ í•˜ëŠ” ì‘ì—…(list, describe)ëŠ” ì•„ë¬´ ë¸Œë¡œì»¤ì—ì„œë‚˜ ìˆ˜í–‰ë  ìˆ˜ ìˆê³  í´ë¼ì´ì–¸íŠ¸ ì…ì¥ì—ì„œ ë³´ì´ëŠ” ê°€ì¥ ë¶€í•˜ê°€ ì ì€ ë¸Œë¡œì»¤ë¡œ ì „ë‹¬

## 5.2 AdminClient ì‚¬ìš©ë²•: ìƒì„±, ì„¤ì •, ë‹«ê¸°

ì±…ì— ìˆëŠ” ì½”ë“œ ì •ìƒì‘ë™ í™•ì¸í•¨

```java
import java.time.Duration;
import java.util.Properties;
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;

public class KafkaAdminClient {

  public static void main(String[] args) {
    Properties props = new Properties();
    props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
    AdminClient admin = AdminClient.create(props);

    admin.close(Duration.ofSeconds(30)); //closeì˜ ì¸ìë¡œ ì „ë‹¬ëœ Durationì´ timeout
  }
}
```

**close()ë©”ì„œë“œì˜ ì¸ì: timeout**

timeoutì„ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ê°€ ëª¨ë“  ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼

timeoutì„ ì„¤ì •í•˜ë©´ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆë”ë¼ë„ ëª¨ë“  ì§„í–‰ ì¤‘ì¸ ì‘ë™ì„ ë©ˆì¶”ê³  ëª¨ë“  ìì›ì„ í•´ì œí•¨

### 5.2.1 client.dns.lookup

---

- ë¨¼ì € ì´í•´í•˜ê¸°

ë¡œì»¬ì—ì„œëŠ” ì´ëŸ° ì‹ìœ¼ë¡œ ì„¤ì •í•¨

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/6db4402a-b90b-45e9-903e-6b89bf00737e)


bootStrap server ì„¤ì •(ë¸Œë¡œì»¤):

props.put(AdminClientConfig.*BOOTSTRAP_SERVERS_CONFIG*, "localhost:9092");

listener ì„¤ì •:
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-local:9092,PLAINTEXT_HOST://localhost:29092

AWS MSK

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/1790aec4-270e-48d4-a17e-67a8b8cbf1df)


bootstrap-servers: AAA.amazonaws.com:9092, BBB.amazonaws.com:9092, CCC.amazonaws.com:9092

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/ebbc7636-52a5-49b7-a959-204e6e13efbb)


<aside>
ğŸ’¡ â†’ MSKì˜ ê²½ìš° bootstrap-serversë¥¼ DNS ë³„ì¹­ì´ ì•„ë‹ˆë¼ ì­‰ ëŠ˜ì–´ì“°ê³  ë¡œë“œë°¸ëŸ°ì„œë„ ì•ë‹¨ì— ì•ˆë‘ëŠ”ê²Œ ì¼ë°˜ì ì´ë¼ê³  í•¨. ê·¸ë¦¬ê³  GPTë§ì²˜ëŸ¼ AWS MSKê°€ í´ëŸ¬ìŠ¤í„° ìƒì„± ì‹œì— ìë™ìœ¼ë¡œ DNS ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŒ!!!
feat. ë¦¬ëˆ„ìŠ¤ë‹˜

</aside>

**ë¦¬ìŠ¤ë„ˆ ê´€ë ¨ í”„ë¡œí† ì½œ**

PLAINTEXT: ë³´ì•ˆì ì¸ ìš”êµ¬ê°€ ì—†ëŠ” í…ìŠ¤íŠ¸ê¸°ë°˜ì˜ í†µì‹ 

SSL(Secure Socket Layer): í´ë¼ì´ì–¸íŠ¸ì™€ ë¸Œë¡œì»¤ê°„ ì•”í˜¸í™”í•˜ì—¬ ë³´ì•ˆ ì„¤ì •

SASL_SSL(Simple Authentication and Security Layer): SASLì„ í†µí•´ SSLì„ ì ìš©í•œ ë¦¬ìŠ¤ë„ˆ. í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ë¥¼ í•´ì¤„ ë•Œ ì‚¬ìš©í•¨

---

í˜¸ìŠ¤íŠ¸(bootstrap-server)ëŠ” ì„¤ì •í•´ì•¼í•˜ë¯€ë¡œ ë¸Œë¡œì»¤ë¡œë¶€í„° í˜¸ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë°›ê³ , advertised.listeners ì„¤ì •ì— ìˆëŠ” í˜¸ìŠ¤íŠ¸ëª…ì„ ê¸°ì¤€ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ - ë¸Œë¡œì»¤ í´ëŸ¬ìŠ¤í„°ê°„ ì—°ê²°ì´ ëœë‹¤. ê·¸ëŸ¬ë‚˜ ì•„ë˜ ë‘ ê°€ì§€ì˜ ê²½ìš° ì´ ë°©ì‹ëŒ€ë¡œ 

ì‘ë™ì•ˆí•˜ëŠ” ê²½ìš°ê°€ ìƒê¸´ë‹¤.

1. DNS ë³„ì¹­

ìœ„ì—ì„œ ì‚´í´ë³¸ëŒ€ë¡œ ë§ì€ ë¸Œë¡œì»¤ í˜¸ìŠ¤íŠ¸ ì£¼ì†Œê°€ ìˆì„ ë•Œ, [all-brokers.hostname.com](http://all-brokers.hostname.com) ìœ¼ë¡œ DNSë¥¼ ì„¤ì •í•˜ì—¬ ë¶€íŠ¸ìŠ¤íŠ¸ë© ì„¤ì •ìœ¼ë¡œ ì¤„ ìˆ˜ ìˆë‹¤. ì´ëŸ° ê²½ìš°ì¸ë°, SASLì„ ì‚¬ìš©í•´ì„œ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ê²½ìš°ì— ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” all-brokers.hostname.com ìœ¼ë¡œ ì¸ì¦ì„ í• ë ¤ê³  í•˜ëŠ”ë° ì„œë²„ì˜ ë³´ì•ˆ ì£¼ì²´ëŠ” ë¸Œë¡œì»¤ í˜¸ìŠ¤íŠ¸( ex) broker2.hostname.com)ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ SASLì€ ì¸ì¦ì„ ê±°ë¶€í•˜ê³  ì—°ê²°ë„ ì‹¤íŒ¨í•œë‹¤. ì´ëŸ´ ê²½ìš°ì— client.dns.lookup=resolve_canonical_bootstrap_servers_onlyë¡œ ì„¤ì •í•´ì£¼ë©´ DNS ë³„ì¹­ì— í¬í•¨ëœ ëª¨ë“  ë¸Œë¡œì»¤ ì´ë¦„ì„ ë¶€íŠ¸ìŠ¤íŠ¸ë© ì„œë²„ ëª©ë¡ì— ë„£ì–´ì¤€ ê²ƒê³¼ ë™ì¼í•˜ê²Œ ì‘ë™í•œë‹¤.

1. ë‹¤ìˆ˜ì˜ IP ì£¼ì†Œë¡œ DNS ì´ë¦„ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/f59aee84-4aad-403f-a916-d7a190dbd435)


ë¡œë“œë°¸ëŸ°ì„œ(Load Balancer, LB)ë¥¼ ì—¬ëŸ¬ ëŒ€ ë‘ì–´ ì¥ì• ë¥¼ í”¼í•œë‹¤. ì¦‰ ex.comì´ë¼ëŠ” ë„ë©”ì¸ì— ìœ„ ê·¸ë¦¼ì²˜ëŸ¼ ê° IP ì£¼ì†Œë¥¼ ê°–ëŠ” LBê°€ ì—°ê²°ëœ ê²½ìš°ì¸ ê²ƒì´ë‹¤. ê·¸ëŸ°ë° ë§Œì•½ 1ê°œì˜ LBì˜ IP ì£¼ì†Œê°€ ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ ë³€ê²½ëì„ ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ì— ì˜í•´ í•´ì„ëœ IP ì£¼ì†Œê°€ ì‚¬ìš© ë¶ˆëŠ¥ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ë²„ë¦´ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¼ ì¹´í”„ì¹´ í´ë¼ì´ì–¸íŠ¸ëŠ” ë’· ë‹¨ì˜ Brokerë“¤ì€ ë©€ì©¡í•œë°ë„ ë¶ˆêµ¬í•˜ê³  ì—°ê²°ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œë“œ ë°¸ëŸ°ì‹± ê³„ì¸µì˜ ê³ ê°€ìš©ì„±ì„ í™œìš©í•  ìˆ˜ ìˆë„ë¡ client.dns.lookup=use_all_dns_ipsë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°•ë ¥íˆ ê¶Œì¥ëœë‹¤.

### 5.2.2 request.timeout.ms

AdminClientì˜ ì‘ë‹µì„ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆëŠ” ì‹œê°„ì˜ ìµœëŒ€ê°’ì„ ì •ì˜. ê¸°ë³¸ê°’ì€ 120ì´ˆ.

â†’ í˜¹ì‹œ ìš°ë¦¬ í…ŒìŠ¤íŠ¸ ë¬¸ì œë„ ë¸Œë¡œì»¤ì˜ ì‘ë‹µì‹œê°„ì´ ëŠë ¤ì„œ ì´ ê°’ì„ ë„˜ì–´ê°€ì„œ ë°œìƒí•œ ê²ƒì€ ì•„ë‹ê¹Œ ì‹¶ìŒ.

ì±… ë‚´ìš©: ë¸Œë¡œì»¤ê°€ ì‘ë‹µí•˜ëŠ”ë° 30ì´ˆ ì´ìƒ ê±¸ë¦´ ê²½ìš°, í™•ì¸ ì‘ì—…ì„ê±´ë„ˆë›°ê±°ë‚˜ ì¼ë‹¨ ì„œë²„ ê¸°ë™ì„ ê³„ì†í•œ ë’¤ ë‚˜ì¤‘ì— í† í”½ì˜ ì¡´ì¬ë¥¼ í™•ì¸í•œë‹¤.

## 5.3 í•„ìˆ˜ì ì¸ í† í”½ ê´€ë¦¬ ê¸°ëŠ¥

í† í”½í™•ì¸: listTopics()

```java
ListTopicResult topics = admin.listTopics();
topics.names().get().forEach(System.out::println);
```

ì±…ì— ë‚˜ì˜¨ ë¶ˆì™„ì „í•œ ì½”ë“œë¥¼ ìš°ë¦¬ í”„ë¡œì íŠ¸ì— ë§ì¶°ì„œ ì¶œë ¥í•´ë´¤ìŒ

```java
import java.time.Duration;
import java.util.List;
import java.util.Properties;
import java.util.concurrent.ExecutionException;
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;
import org.apache.kafka.clients.admin.DescribeTopicsResult;
import org.apache.kafka.clients.admin.TopicDescription;

public class KafkaAdminClient {

  public static void main(String[] args) {
    Properties props = new Properties();
    props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:29092");
    AdminClient admin = AdminClient.create(props);

    DescribeTopicsResult demoTopic = admin.describeTopics(
        List.of("pos-sync-legacy-master"));

    try {
      TopicDescription topicDescription = demoTopic.topicNameValues().get("pos-sync-legacy-master")
          .get();

      System.out.println("###" + topicDescription);

    } catch (ExecutionException e) {
      throw new RuntimeException(e);
    } catch (InterruptedException e) {
      throw new RuntimeException(e);
    }

    admin.close(Duration.ofSeconds(30));
  }
}
```

ì½˜ì†”ì— ì°íŒ ë¡œê·¸: íŒŒí‹°ì…˜ 3ê°œê°€ ì¶œë ¥ë˜ëŠ” ê²ƒ í™•ì¸: TopicDescription ê°ì²´ëŠ” ë‹¤ìŒê³¼ ê°™ìŒ

###(name=pos-sync-legacy-master, internal=false, partitions=(**`partition=0,`** leader=localhost:29092 (id: 1 rack: null), replicas=localhost:29092 (id: 1 rack: null), isr=localhost:29092 (id: 1 rack: null)),(`partition=1,` leader=localhost:29092 (id: 1 rack: null), replicas=localhost:29092 (id: 1 rack: null), isr=localhost:29092 (id: 1 rack: null)),(`partition=2,` leader=localhost:29092 (id: 1 rack: null), replicas=localhost:29092 (id: 1 rack: null), isr=localhost:29092 (id: 1 rack: null)), authorizedOperations=null)

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/7d3dc3ff-7b55-4832-bd51-b83db75f57e1)


**deleteTopics() ë©”ì„œë“œ**

ëª©ë¡ ì¸ìë¡œ ë„˜ê²¨ì¤€ í† í”½ë“¤ì„ ì‚­ì œí•¨. ëŒì´í‚¬ ìˆ˜ ì—†ì´ ì™„ì „íˆ ì‚­ì œë˜ë¯€ë¡œ ë°ì´í„° ìœ ì‹¤ ë“±ì— íŠ¹ë³„íˆ ì£¼ì˜í•´ì•¼í•œë‹¤.

## 5.4 ì„¤ì • ê´€ë¦¬

ConfigResource ê°ì²´ë¥¼ í†µí•´ì„œ í•  ìˆ˜ ìˆìŒ. êµì¬ì˜ ì½”ë“œëŠ” ë¡œê·¸ ì••ì°© ì„¤ì •ì´ ë˜ì§€ ì•Šì€ í† í”½ì„ í™•ì¸í•˜ê³  ë¡œê·¸ ì••ì°© ì„¤ì •ì„ ë„£ì–´ì£¼ëŠ” ë‚´ìš©

```java
import java.time.Duration;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Properties;
import java.util.concurrent.ExecutionException;
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;
import org.apache.kafka.clients.admin.AlterConfigOp;
import org.apache.kafka.clients.admin.Config;
import org.apache.kafka.clients.admin.ConfigEntry;
import org.apache.kafka.clients.admin.DescribeConfigsResult;
import org.apache.kafka.common.config.ConfigResource;
import org.apache.kafka.common.config.ConfigResource.Type;
import org.apache.kafka.common.config.TopicConfig;

public class KafkaAdminClient {

  public static void main(String[] args) throws ExecutionException, InterruptedException {
    Properties props = new Properties();
    props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:29092");
    AdminClient admin = AdminClient.create(props);

    ConfigResource configResource = new ConfigResource(Type.TOPIC, "pos-sync-legacy-master");
    DescribeConfigsResult configsResult = admin.describeConfigs(
        Collections.singleton(configResource));
    Config configs = configsResult.all().get().get(configResource);

    //ê¸°ë³¸ê°’ì´ ì•„ë‹Œ ì„¤ì •ì„ ì¶œë ¥
    configs.entries().stream().filter(
        entry -> !entry.isDefault())
        .forEach(System.out::println);

    //í† í”½ ì••ì°© ì„¤ì • í™•ì¸
    ConfigEntry compaction = new ConfigEntry(TopicConfig.CLEANUP_POLICY_CONFIG,
        TopicConfig.CLEANUP_POLICY_COMPACT);
    if (!configs.entries().contains(compaction)) {
      // ì••ì°© ì„¤ì • ë˜ì–´ìˆì§€ ì•Šì€ ê²½ìš° í•´ì¤Œ
      Collection<AlterConfigOp> configOp = new ArrayList<>();
      configOp.add(new AlterConfigOp(compaction, AlterConfigOp.OpType.SET));
      HashMap<ConfigResource, Collection<AlterConfigOp>> alterConf = new HashMap<>();
      alterConf.put(configResource, configOp);
      admin.incrementalAlterConfigs(alterConf).all().get();
      System.out.println("### ì••ì°© í–ˆìŒ!");
    } else {
      System.out.println("Topic " + "pos-sync-legacy-master" + "is compacted topic");
    }

    admin.close(Duration.ofSeconds(30));
  }
}

```

ì½”ë“œ ì‹¤í–‰ ì „ KafUI í™”ë©´

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/45d9f0b2-5cdb-4037-8300-cbdd80f11540)


ì‹¤í–‰ í›„

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/20ba62cd-6566-4775-9172-9302300e4123)


## 5.5 ì»¨ìŠˆë¨¸ ê·¸ë£¹ ê´€ë¦¬

AdminClientë¥¼ ì‚¬ìš©í•´ì„œ í”„ë¡œê·¸ë¨ì ìœ¼ë¡œ ì»¨ìŠˆë¨¸ ê·¸ë£¹ê³¼ ì´ ê·¸ë£¹ë“¤ì´ ì»¤ë°‹í•œ ì˜¤í”„ì…‹ì„ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³¸ë‹¤.

### 5.5.1 ì»¨ìŠˆë¨¸ ê·¸ë£¹ ì‚´í´ë³´ê¸°

```java
admin.listconsumerGroups().valid().get().forEach(System.out::println);
```

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/f44052da-a6f1-4c44-b916-71d2191a0ff3)


íŠ¹ì • ê·¸ë£¹ì— ëŒ€í•´ ìƒì„¸ ì •ë³´ ì‚´í´ë³´ê¸°

```java
import java.time.Duration;
import java.util.Collections;
import java.util.Properties;
import java.util.concurrent.ExecutionException;
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;
import org.apache.kafka.clients.admin.ConsumerGroupDescription;

public class KafkaAdminClient {

  public static void main(String[] args) throws ExecutionException, InterruptedException {
    Properties props = new Properties();
    props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:29092");
    AdminClient admin = AdminClient.create(props);

    ConsumerGroupDescription groupDescription = admin.describeConsumerGroups(
            Collections.singleton("pos-sync-legacy-master-consumer"))
        .describedGroups().get("pos-sync-legacy-master-consumer").get();

    System.out.println("$$$$$" + groupDescription);

    admin.close(Duration.ofSeconds(30));
  }
}
```

ì¶œë ¥ ê²°ê³¼

$$$$$(groupId=pos-sync-legacy-master-consumer, isSimpleConsumerGroup=false, members=(memberId=consumer-pos-sync-legacy-master-consumer-5-82d14242-fc74-470c-8f3c-c56ac51b5c96, groupInstanceId=null, clientId=consumer-pos-sync-legacy-master-consumer-5, host=/192.168.65.1, assignment=(topicPartitions=pos-sync-legacy-master-1)),(memberId=consumer-pos-sync-legacy-master-consumer-6-7f7a085f-ec3a-44fc-a47f-860377833853, groupInstanceId=null, clientId=consumer-pos-sync-legacy-master-consumer-6, host=/192.168.65.1, assignment=(topicPartitions=pos-sync-legacy-master-2)),(memberId=consumer-pos-sync-legacy-master-consumer-4-6186099a-ce5c-4c70-9ccc-c6e48b0bddf3, groupInstanceId=null, clientId=consumer-pos-sync-legacy-master-consumer-4, host=/192.168.65.1, assignment=(topicPartitions=pos-sync-legacy-master-0)), partitionAssignor=range, state=Stable, coordinator=localhost:29092 (id: 1 rack: null), authorizedOperations=null)

**ì»¤ë°‹ ì •ë³´ ì–»ì–´ì˜¤ê¸°**

```java
import java.time.Duration;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.ExecutionException;
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;
import org.apache.kafka.clients.admin.ListOffsetsResult.ListOffsetsResultInfo;
import org.apache.kafka.clients.admin.OffsetSpec;
import org.apache.kafka.clients.consumer.OffsetAndMetadata;
import org.apache.kafka.common.TopicPartition;

public class KafkaAdminClient {

  public static void main(String[] args) throws ExecutionException, InterruptedException {
    Properties props = new Properties();
    props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:29092");
    AdminClient admin = AdminClient.create(props);

    Map<TopicPartition, OffsetAndMetadata> offsets = admin.listConsumerGroupOffsets(
        "pos-sync-legacy-master-consumer").partitionsToOffsetAndMetadata().get();
    HashMap<TopicPartition, OffsetSpec> requestLatestOffsets = new HashMap<>();

    for (TopicPartition tp : offsets.keySet()) {
      requestLatestOffsets.put(tp, OffsetSpec.latest());
    }

    Map<TopicPartition, ListOffsetsResultInfo> latestOffsets = admin.listOffsets(
        requestLatestOffsets).all().get();

    for (Map.Entry<TopicPartition, OffsetAndMetadata> e : offsets.entrySet()) {
      String topic = e.getKey().topic();
      int partition = e.getKey().partition();
      long offset = e.getValue().offset();
      long latestOffset = latestOffsets.get(e.getKey()).offset();
      System.out.println("$$$" + topic + partition + offset + latestOffset);
    }

    admin.close(Duration.ofSeconds(30));
  }
}
```

### 5.5.2 ì»¨ìŠˆë¨¸ ê·¸ë£¹ ìˆ˜ì •í•˜ê¸°

ì±…ì—ì„œëŠ” íŠ¹ì • ì»¨ìŠˆë¨¸ ê·¸ë£¹ì˜ ì˜¤í”„ì…‹ì„ ìˆ˜ì •í•˜ëŠ” ê²ƒì— ëŒ€í•´ì„œ ì„¤ëª…í•¨. íŠ¹íˆ ë§¨ ì²˜ìŒ ì˜¤í”„ì…‹ ê°’ìœ¼ë¡œ ë¦¬ì…‹í•˜ëŠ” ê³¼ì •ì„ ì„¤ëª…í•œë‹¤.

- ì¹´í”„ì¹´ì—ì„œëŠ” í˜„ì¬ ì‘ì—…ì´ ëŒì•„ê°€ê³  ì‡ëŠ” ì»¨ìŠˆë¨¸ ê·¸ë£¹ì— ëŒ€í•œ ì˜¤í”„ì…‹ì„ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ ì´ë¥¼ ìœ„í•´ì„œëŠ” ì»¨ìŠˆë¨¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êº¼ì•¼í•œë‹¤.
- ì˜¤í”„ì…‹ì„ ë¦¬ì…‹í•˜ê³  ë§¨ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì»¨ìŠˆë¨¸ê·¸ë£¹ì´ ëŒì•„ê°€ê²Œ í•˜ë©´ ì €ì¥ëœ ìƒíƒœê°€ ê¹¨ì§ˆ ìˆ˜ ìˆë‹¤. ë©”ì‹œì§€ê°€ ì¤‘ë³µì²˜ë¦¬ë  ìˆ˜ë„ ìˆë‹¤.

ì±…ì—ì„œëŠ” ìµœì´ˆ offset ê°’ì„ ì°¾ëŠ”ë°, ë‚´ ìƒê°ì—” íŠ¹ì • ì‹œì ì˜ ì˜¤í”„ì…‹ ê°’ì„ ì°¾ì•„ì„œ ê·¸ë•Œë¡œ ì˜¤í”„ì…‹ì„ ì„¤ì •í•´ì£¼ëŠ”ê²Œ ìœ ìš©í•  ê²ƒ ê°™ì•„ì„œ GPTì— ë¬¼ì–´ë´„

```java
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;
import org.apache.kafka.clients.admin.AlterConsumerGroupOffsetsResult;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.TopicPartition;
import org.apache.kafka.clients.consumer.OffsetAndTimestamp;
import org.apache.kafka.common.requests.OffsetFetchResponse.PartitionData;

import java.time.Duration;
import java.time.Instant;
import java.util.*;
import java.util.concurrent.ExecutionException;

public class KafkaOffsetSetter {

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        String bootstrapServers = "localhost:9092";
        String groupId = "your-consumer-group";
        String topic = "your-topic";
        long timestampToSeek = 1622505600000L; // íŠ¹ì • ì‹œì ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ (ì˜ˆ: 2023-01-01 00:00:00)

        Properties consumerProps = new Properties();
        consumerProps.put("bootstrap.servers", bootstrapServers);
        consumerProps.put("group.id", groupId);
        consumerProps.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        consumerProps.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");

        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(consumerProps);

        // íŠ¹ì • ì‹œì ì˜ ì˜¤í”„ì…‹ ì°¾ê¸°
        List<TopicPartition> partitions = consumer.partitionsFor(topic).stream()
                .map(partitionInfo -> new TopicPartition(topic, partitionInfo.partition()))
                .collect(Collectors.toList());

        Map<TopicPartition, Long> timestampsToSearch = new HashMap<>();
        for (TopicPartition partition : partitions) {
            timestampsToSearch.put(partition, timestampToSeek);
        }

        Map<TopicPartition, OffsetAndTimestamp> offsetsForTimes = consumer.offsetsForTimes(timestampsToSearch);
        Map<TopicPartition, Long> partitionOffsets = new HashMap<>();
        for (Map.Entry<TopicPartition, OffsetAndTimestamp> entry : offsetsForTimes.entrySet()) {
            partitionOffsets.put(entry.getKey(), entry.getValue().offset());
        }

        // AdminClientë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨ìŠˆë¨¸ ê·¸ë£¹ì˜ ì˜¤í”„ì…‹ ì„¤ì •
        Properties adminProps = new Properties();
        adminProps.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);

        AdminClient adminClient = AdminClient.create(adminProps);
        Map<TopicPartition, OffsetAndMetadata> offsetsToCommit = new HashMap<>();
        for (Map.Entry<TopicPartition, Long> entry : partitionOffsets.entrySet()) {
            offsetsToCommit.put(entry.getKey(), new OffsetAndMetadata(entry.getValue()));
        }

        AlterConsumerGroupOffsetsResult result = adminClient.alterConsumerGroupOffsets(groupId, offsetsToCommit);
        result.all().get();  // ì„¤ì •ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°

        consumer.close();
        adminClient.close();
    }
}
```

ê¶ê¸ˆí–ˆë˜ ì 

![image](https://github.com/room-of-coding/backend-deep-dive/assets/61934302/8d7824c1-c94c-4625-8970-47edcb2892f9)


## 5.6 í´ëŸ¬ìŠ¤í„° ë©”íƒ€ë°ì´í„°

admin.describeCluster(); ë©”ì„œë“œ ì‹¤í–‰ìœ¼ë¡œ ê°€ëŠ¥í•¨!

## 5.7 ê³ ê¸‰ ì–´ë“œë¯¼ ì‘ì—…

### 5.7.1 í† í”½ì— íŒŒí‹°ì…˜ ì¶”ê°€í•˜ê¸°

í† í”½ì˜ íŒŒí‹°ì…˜ ìˆ˜ëŠ” í† í”½ì´ ìƒì„±ë  ë•Œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë³´í†µì´ê³ , íŒŒí‹°ì…˜ì— ë©”ì‹œì§€ê°€ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë  ê²ƒì„ ê¸°ëŒ€í•˜ê¸° ë•Œë¬¸ì— ì¤‘ê°„ì— íŒŒí‹°ì…˜ ìˆ˜ë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì€ ìœ„í—˜í•  ìˆ˜ ìˆë‹¤. ë˜í•œ ì—¬ëŸ¬ í† í”½ì„ í•œ ë²ˆì— í™•ì¥í•  ê²½ìš° ì¼ë¶€ í† í”½ì€ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì‹¤íŒ¨í•  ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ìœ ì˜í•´ì•¼í•œë‹¤.

```java
Map<String, NewPartitions> newPartitions = new HashMap<>);
newPartitions.put(TOPIC_NAME, NewPartitions. increaseTo(NUM_PARTITIONS+2));
admin.**createPartitions**(newPartitions).all).get();
```

### 5.7.2 í† í”½ì—ì„œ ë ˆì½”ë“œ ì‚­ì œí•˜ê¸°

deleteRecords ë©”ì„œë“œ: í˜¸ì¶œ ì‹œì ì„ ê¸°ì¤€ìœ¼ë¡œ ì§€ì •ëœ ì˜¤í”„ì…‹ë³´ë‹¤ ë” ì˜¤ë˜ëœ ëª¨ë“  ë ˆì½”ë“œì— ì‚­ì œ í‘œì‹œë¥¼ í•´ì„œ ì»¨ìŠˆë¨¸ê°€ ì ‘ê·¼ ëª»í•˜ê²Œ í•¨

### 5.7.3 ë¦¬ë” ì„ ì¶œ

**ì„ í˜¸ ë¦¬ë” ì„ ì¶œ(preferred leader election)**
ì„ í˜¸ ë¦¬ë”ë€ í† í”½ì´ ì²˜ìŒ ìƒì„±ë˜ì—ˆì„ ë•Œ ë¦¬ë” ë ˆí”Œë¦¬ì¹´ì˜€ë˜ ë ˆí”Œë¦¬ì¹´ë¥¼ ëœ»í•¨.
ì¹´í”„ì¹´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì—¬ëŸ¬ ë ˆí”Œë¦¬ì¹´ë¡œ ì´ë£¨ì–´ì§„ íŒŒí‹°ì…˜ ì¤‘ ë¦¬ë” íŒŒí‹°ì…˜ì„ 5ë¶„ë§ˆë‹¤ ì„ ì¶œí•˜ì—¬ ìˆœíšŒì‹œí‚´. ë§Œì•½ auto.leader.rebalance.enable = falseì´ê±°ë‚˜ ì§ì ‘ ì„ í˜¸ ë¦¬ë” ì„ ì¶œ ê³¼ì •ì„ ì‘ë™ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ AdminClientì˜ electLeader() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë¨

**ì–¸í´ë¦° ë¦¬ë” ì„ ì¶œ(unlcean leader election)**

ë¦¬ë” íŒŒí‹°ì…˜ì´ ì‚¬ìš© ë¶ˆëŠ¥ ìƒíƒœê°€ ë˜ì—ˆëŠ”ë°, ë‹¤ë¥¸ ë ˆí”Œë¦¬ì¹´ íŒŒí‹°ì…˜ë“¤ì´ ë°ì´í„°ê°€ ì—†ëŠ” ë“±ì˜ ì´ìœ ë¡œ ë¦¬ë”ë¥¼ ëª» ë§¡ëŠ”ë‹¤ë©´ ë¦¬ë” ì§€ì •ì´ ë¶ˆê°€í•˜ì—¬ íŒŒí‹°ì…˜ì´ ì‚¬ìš© ë¶ˆëŠ¥ ìƒíƒœê°€ ëœë‹¤. ì´ ë•Œ electLeader() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë ˆí”Œë¦¬ì¹´ íŒŒí‹°ì…˜ ì¤‘ í•˜ë‚˜ë¥¼ ê·¸ëƒ¥ ë¦¬ë”ë¡œ ì„ ì¶œí•œë‹¤. ì´ ê²½ìš° ìƒˆ ë¦¬ë”ë¡œ ë³µì œë˜ì§€ ì•Šì€ ëª¨ë“  ì´ë²¤íŠ¸ë“¤ì€ ìœ ì‹¤ëœë‹¤.

### 5.7.4 ë ˆí”Œë¦¬ì¹´ ì¬í• ë‹¹

íŒŒí‹°ì…˜ ë ˆí”Œë¦¬ì¹´ì˜ ìœ„ì¹˜ë¥¼ ë³€ê²½í•˜ê³  ì‹¶ì„ ë•Œ alterPartitionReassignmentsë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ë‹¤ë§Œ, íŒŒí‹°ì…˜ ì´ë™ ì‹œ ë¸Œë¡œì»¤ê°„ ëŒ€ëŸ‰ì˜ ë°ì´í„° ë³µì œë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ì— ì£¼ì˜í•˜ê³ , í•„ìš”í•  ê²½ìš° ì¿¼í„°ë¥¼ ì„¤ì •í•´ì„œ ë³µì œ ì‘ì—…ì„ ìŠ¤ë¡œí‹€ë§ í•´ì¤˜ì•¼í•œë‹¤.

## 5.8 í…ŒìŠ¤íŠ¸í•˜ê¸°

MockAdminClient í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•´ì„œ í…ŒìŠ¤íŠ¸ í•œë‹¤ëŠ”ë°, ì±… ë‚´ìš©ìœ¼ë¡œëŠ” ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ì•ˆë¨. GPTë„ ì œëŒ€ë¡œ ì•ˆ ì•Œë ¤ì¤˜ì„œ ì¢€ ë” ê¹Šê²Œ ë´ì•¼í• ë“¯

```java
import lombok.RequiredArgsConstructor;
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.NewTopic;

import java.util.Collections;
import java.util.concurrent.ExecutionException;

@RequiredArgsConstructor
public class KafkaAdminService {
  private final AdminClient adminClient;

  public void createTopic(String topicName, int numPartitions, short replicationFactor) throws ExecutionException, InterruptedException {
    NewTopic newTopic = new NewTopic(topicName, numPartitions, replicationFactor);
    adminClient.createTopics(Collections.singleton(newTopic)).all().get();
  }
}
```

```java
import org.apache.kafka.clients.admin.AdminClient;
import org.apache.kafka.clients.admin.AdminClientConfig;
import org.apache.kafka.clients.admin.NewTopic;
import org.apache.kafka.clients.admin.MockAdminClient;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.Mockito;

import java.util.Collections;
import java.util.Map;
import java.util.concurrent.ExecutionException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.Mockito.*;

@SpringBootTest(classes = KafkaAdminService.class)
public class KafkaAdminServiceTest {

  @Autowired
  private KafkaAdminService kafkaAdminService;

  @BeforeEach
  public void setUp() {
    kafkaAdminService = new KafkaAdminService(new MockAdminClient());
  }

  @Test
  public void testCreateTopic() throws ExecutionException, InterruptedException {
    // Arrange
    String topicName = "test-topic";
    int numPartitions = 3;
    short replicationFactor = 1;

    // Mocking the createTopics method
    when(adminClient.createTopics(any())).thenReturn();

    // Act
    kafkaAdminService.createTopic(topicName, numPartitions, replicationFactor);

    // Assert
    ArgumentCaptor<NewTopic> topicCaptor = ArgumentCaptor.forClass(NewTopic.class);
    verify(adminClient, times(1)).createTopics(Collections.singleton(topicCaptor.capture()));

    NewTopic capturedTopic = topicCaptor.getValue();
    assertEquals(topicName, capturedTopic.name());
    assertEquals(numPartitions, capturedTopic.numPartitions());
    assertEquals(replicationFactor, capturedTopic.replicationFactor());
  }
}
```
