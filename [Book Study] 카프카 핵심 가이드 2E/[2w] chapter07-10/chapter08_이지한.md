# chapter 08. '정확히 한 번' 의미 구조

## 정확히 한 번
* 멱등적 프로듀서 : 프로듀서 재시도로 인해 발생하는 중복 방지
* 트랜젝션 : 스트림 처리 애플리케이션에서 '정확히 한 번' 처리를 보장

## 멱등적 프로듀서

* 멱등적 : 동일 작업을 여러 번 실행해도 **한 번 실행한 것과 결과가 같은 서비스**
```sql
-- 멱등 X
1. UPDATE t SET x=x+1 where y=5
-- 멱등 O
2. UPDATE t SET x=18 where y=5
```
### 멱등적 프로듀서의 작동 원리

* 고유한 프로듀서 ID와 시퀀스 넘버를 가짐
* 브로커가 이전에 받은 적이 있는 메시지를 받게되면, 적절한 에러를 발생
  * 프로듀서에 로깅되고 지표에도 반영되지만, 예외가 발생한 것은 아니라 사용자에게 경고를 보내지는 않음
  * RequestMetrics 유형의 ErrorsPerSec 지표값에 기록됨

### 작동 실패 시, 멱등적 프로듀서 처리

1. 프로듀서 재시작
* 멱등적 프로듀서 기능이 켜져있다면, 프로듀서 초기화 과정에서 브로커로부터 프로듀서 ID를 생성받음
* 트랜젝션 기능이 꺼져있다면, 프로듀서 초기화할 때마다 완전히 새로운 ID가 생성됨
* 따라서 새 프로듀서가 기존 프로듀서가 이미 전송한 메시지를 다시 전송할 경우, 브로커는 중복이 발생한지 모름.

2. 브로커 장애
* 리더는 새 메시지가 쓰여질 때마다 인-메모리 프로듀서 상태에 최근 5개의 시퀀스 넘버를 업데이트함.
* 리더 브로커 장애로 팔로워가 리더가 된 시점에 메모리에 최근 5개의 시퀀스 넘버를 가지고 있음.
  * 따라서 아무 이슈나 지연 없이 새로운 메시지 유효성 검증 재개
* 예전 리더가 다시 돌아오면?
  * 스냅샷 파일에서 최신 상태를 읽어오고, 현재 리더로부터 복제한 레코드를 사용해서 프로듀서 상태를 업데이트함.

### 멱등적 프로듀서의 한계
* 프로듀서 내부 로직으로 인한 재시도(프로듀서, 네트워크, 브로커 에러)가 발생할 경우 생기는 중복만 방지함.
* producer.send() 두 번 호출하면 중복이 발생함.


### 멱등적 프로듀서 사용법
```
enable.idempotence=true
```
위의 기능을 활성화 하면 다음처럼 동작함.
* 프로듀서 ID를 받아오기 위해 프로듀서 시동 시 API 호출
* 레코드 배치에 프로듀서 ID와, 첫 메시지의 시퀀스 포함
* 레코드 배치의 시퀀스 넘버를 검증해서 메시지 중복을 방지
* 장애가 발생하더라도 파티션에 쓰여지는 메시지들의 순서는 보장됨.

## 트랜잭션

### 트랜잭션이 해결하는 문제

* 상황 가정
  * 원본 토픽으로부터 이벤트를 읽어서 처리 후, 결과를 다른 토픽에 쓴다.

1. 애플리케이션 크래시로 인한 재처리
* 결과를 다른 토픽에 썼는데, 원본 토픽 입력 오프셋이 커밋되기 전에 애플리케이션이 크래시 발생!
* 컨슈머 리밸런스가 발생하고, 컨슈머가 읽고있던 파티션들은 다른 컨슈머로 재할당 됨.
* 할당받은 컨슈머가 마지막 커밋 오프셋부터 레코드를 읽기 시작함.
* 중복 처리 발생.

2. 좀비 애플리케이션에 의해 발생하는 재처리
* 
