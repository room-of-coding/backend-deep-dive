# chapter 08. '정확히 한 번' 의미 구조

## 정확히 한 번
* 멱등적 프로듀서 : 프로듀서 재시도로 인해 발생하는 중복 방지
* 트랜젝션 : 스트림 처리 애플리케이션에서 '정확히 한 번' 처리를 보장

## 멱등적 프로듀서

* 멱등적 : 동일 작업을 여러 번 실행해도 **한 번 실행한 것과 결과가 같은 서비스**
```sql
-- 멱등 X
1. UPDATE t SET x=x+1 where y=5
-- 멱등 O
2. UPDATE t SET x=18 where y=5
```
### 멱등적 프로듀서의 작동 원리

* 고유한 프로듀서 ID와 시퀀스 넘버를 가짐
* 브로커가 이전에 받은 적이 있는 메시지를 받게되면, 적절한 에러를 발생
  * 프로듀서에 로깅되고 지표에도 반영되지만, 예외가 발생한 것은 아니라 사용자에게 경고를 보내지는 않음
  * RequestMetrics 유형의 ErrorsPerSec 지표값에 기록됨

### 작동 실패 시, 멱등적 프로듀서 처리

1. 프로듀서 재시작
* 멱등적 프로듀서 기능이 켜져있다면, 프로듀서 초기화 과정에서 브로커로부터 프로듀서 ID를 생성받음
* 트랜젝션 기능이 꺼져있다면, 프로듀서 초기화할 때마다 완전히 새로운 ID가 생성됨
* 따라서 새 프로듀서가 기존 프로듀서가 이미 전송한 메시지를 다시 전송할 경우, 브로커는 중복이 발생한지 모름.

2. 브로커 장애
   
